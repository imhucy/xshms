<!--Start Breadcrumb-->
<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb">
			<li><a href="index.html">主 页</a></li>
			<li><a href="javascript:;">系统管理</a></li>
			<li><a href="javascript:;">角色管理</a></li>
		</ol>
	</div>
</div>
<!--End Breadcrumb-->


<div class="row">
	<div class="col-xs-12">
		<div class="box">
			<div class="box-content editable-table">
				<h4 class="fb">说明如下</h4>
				<ol>
					<li>点击表头可以按该列排序，默认按首列排序</li>
					<li>在表头输入数据可以进行数据检索</li>
					<li>删除后数据不可恢复，请慎重操作</li>
					<li>刚添加的数据无法立即修改，请刷新后重试</li>
				</ol>
				<hr>
				<button class="btn btn-info" id="addBtn"> 添 加 <i class="fa fa-plus"></i></button>
				<button class="btn btn-info" id="modifyBtn"> 修 改 <i class="fa fa-pencil"></i></button>
				<button class="btn btn-info" id="removeBtn"> 删 除 <i class="fa fa-trash-o"></i></button>
				<button class="btn btn-info" id="setBtn"> 设置权限 <i class="fa fa-cog"></i></button>
				<table class="table table-bordered table-striped table-hover table-heading table-datatable" id="datatable-role">
					<thead>
						<tr>
							<th><label><input type="hidden" name="id" /></label></th>
							<th><label><input type="text" name="role_name" value="角色名" class="search_init" /></label></th>
							<th><label><input type="text" name="role_desc" value="角色描述" class="search_init" /></label></th>
						</tr>
					</thead>
					<tbody>

					</tbody>
					<tfoot>
						<tr>
							<th></th>
							<th>角色名</th>
							<th>角色描述</th>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</div>
</div>

<div id="removeModal" class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
          	<div class="col-md-12">你确定要删除？</div>
          </div>
          <div class="row">
          	<div class="col-md-8"></div>
          	<div class="col-md-2">
          		<button type="button" class="btn btn-default btn-lg" data-dismiss="modal">取消</button>
          	</div>
          	<div class="col-md-2">
          		<button type="button" id="removeBtn" class="btn btn-primary btn-lg">确定</button>
          	</div>
          </div>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div id="successModal" class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
          	<div class="col-md-12">添加成功</div>
          </div>
          <div class="row">
          	<div class="col-md-10"></div>
          	<div class="col-md-2">
          		<button type="button" class="btn btn-primary btn-lg" data-dismiss="modal">确定</button>
          	</div>
          </div>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal -->
<div class="modal fade" id="setRolePower" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel"> 修改权限 </h4>
      </div>
      <div class="modal-body">
        <form id="setRolePowerForm">
        	<input type="hidden" name="roleId" value="" />
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">取消修改</button>
        <button type="button" class="btn btn-default" id="setFormSureBtn" >确认修改</button>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
// Run Datables plugin and create 3 variants of settings
function AllTables(){
	if ( !$.fn.dataTable.isDataTable( '#datatable-role' ) ){
		// EditabeTableRole();
		EditabeTableModel({
			table:'#datatable-role'
			,widths : [ 0,500,500 ]
			,dbTable : 'role'
		});
	}
	LoadSelect2Script(MakeSelect2);
}
function MakeSelect2(){
	$('select').select2();
	$('.dataTables_filter').each(function(){
		$(this).find('input').attr('placeholder', '全表检索').addClass('form-control');
	});
}

$(document).ready(function() {
	$('.preloader').show();
	$.get('/all/role',function (role) {
		var role = $.parseJSON(role);
		var tBody = $('#datatable-role').find('tbody');
		$.each(role,function  (i,elem) {

			var oTr = $('<tr></tr>');
			oTr.append('<td> <input type="hidden" value="'+elem.id+'" /> </td>');
			oTr.append('<td>'+(elem.role_name)+'</td>');
			oTr.append('<td>'+(elem.role_desc||'-')+'</td>');
			tBody.append(oTr);
		});
		LoadDataTablesScripts(AllTables);
	})

	// Load Datatables and run plugin on tables 
	LoadDataTablesScripts(AllTables);
	// Add Drag-n-Drop feature
	WinMove();
	getAllPower();
});

function getAllPower(){
	$.getJSON('/all/power', function(json, textStatus) {
		var tree = new treeMenu2(json);
		var htmlStr = tree.init(999999);
		console.log(htmlStr)
		$(htmlStr).appendTo('#setRolePower #setRolePowerForm');
		$('#setBtn').click(function(e) {
			var $row   = $('#datatable-role').find('tr.active');
			if( $row.size() === 0 ) return false;
			var RoleId = $row.find('input[type="hidden"]').val();

			$('#setRolePowerForm').find('[name="roleId"]').val( RoleId );
			
			$.post('/getRolePower',{roleId:RoleId})
			.done(function (json){
				json = $.parseJSON(json);
				var inputs = $('#setRolePowerForm').find('input:checkbox');
				if(!json.status){
					return false;
				}
				inputs.each(function (i,item){
					item.checked = false;
				});
				$.each(json.value[1], function(i, item) {
					console.log(item.id)
					inputs.filter('[name="' + item.id + '"]')[0].checked = true
				});

				$('#setRolePower').modal('show');

				inputs.on('click', checkEvent);

				// $('#setRolePower').find('button').on('click',function (){
				// 	inputs.off('click', checkEvent);
				// });

				function checkEvent(e){
				
					if( this.checked ){
						$(this).parents('li').children('.checkbox-inline').find(':checkbox').each(function (i ,item){
							item.checked = true;
						});
					}else{
						$(this).parent().parent().next()
						.find(':checkbox').each(function (i ,item){
							item.checked = false;
						});
					}
				
				}
			});
		});

		$('#setFormSureBtn').click(function(e) {
			var ajaxData = {};
			var form = $('#setRolePowerForm');
			ajaxData['role_id'] = form.find('[name="roleId"]').val();
			ajaxData['powers']  = [];

			form.find('input[type="checkbox"]').each(function (i,item){

				if( item.checked )
				{
					ajaxData['powers'].push( item.name );
				}
			});
			$('#setRolePower').modal('hide');
			$('.preloader').show();
			$.post('/setUserRolePower', {data: JSON.stringify( ajaxData ) }, function(data, textStatus, xhr) {
				var json = $.parseJSON(data);
				console.log( data );
				if( json.status ){
					setTimeout(function(){ 
						$('.preloader').hide();
						$('#successModal').find('.modal-body').text('修改成功');
						$('#successModal').modal('show');
					},1000);
				}else{
					setTimeout(function(){ 
						$('.preloader').hide();
						$('#successModal').find('.modal-body').text('修改失败');
						$('#successModal').modal('show');
					},1000);
				}
			});
			console.log(ajaxData);
		});
	});
}


function treeMenu2(a){
  this.tree=a||[];
  this.groups={};
};
treeMenu2.prototype={
  init:function(pid){
    this.flag = true;
    this.group();
    return this.getDom(this.groups[pid]);
  },
  group:function(){
    for(var i=0;i<this.tree.length;i++){
      if(this.groups[this.tree[i].parent_id]){
        this.groups[this.tree[i].parent_id].push(this.tree[i]);
      }else{
        this.groups[this.tree[i].parent_id]=[];
        this.groups[this.tree[i].parent_id].push(this.tree[i]);
      }
    }
    console.log( JSON.stringify(this.groups) )
  },
  getDom:function(a){
    if(!a){return ''}
  
    var html='\n<ul>\n';
    for(var i=0;i<a.length;i++){
      html+='<li>';
     	// html+='<a href="javascript:;" data-value="'+a[i].id+'">';
      // html+='<span class="hidden-xs">'+a[i].power_name+'</span>';
      // html+='</a>';
			html += '<div class="checkbox-inline"><label><input type="checkbox" checked="false" name="'+ a[i].id +'" />'+a[i].power_name+
			        '<i class="fa fa-square-o"></i></label></div>'
      if(a[i]["power_level"] < 3) html+=this.getDom(this.groups[a[i].id]);
      html+='</li>\n';
    };
    html+='</ul>\n';
    return html;
  }
};
</script>